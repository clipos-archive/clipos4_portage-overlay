#!/bin/sh
# Copyright 2018 ANSSI
# Distributed under the terms of the GNU General Public License v2

error() {
	echo "! $1 !" >&2
	exit 1
}

SITELISP="PREFIX/share/emacs/site-lisp"
SITEETC="PREFIX/share/emacs/etc"
PAGE=$'\f'

SFLIST=$(ls -1 ${SITELISP}/[0-9][0-9]*-gentoo.el ${SITELISP}/site-gentoo.d/[0-9][0-9]*.el 2>/dev/null)

TMPFILE="$(mktemp)"
[[ -n "${TMPFILE}" ]] || error "Failed to create tempfile"

cat >"${TMPFILE}" <<EOF
;;; site-gentoo.el --- site initialisation for Gentoo-installed packages

;;; Commentary:
;; Automatically generated by elisp-common.eclass
;; DO NOT EDIT THIS FILE

;;; Code:
EOF
sed -e '$q' ${SFLIST} >> "${TMPFILE}"
cat >>"${TMPFILE}" <<EOF

${PAGE}
(provide 'site-gentoo)

;; Local Variables:
;; no-byte-compile: t
;; buffer-read-only: t
;; End:

;;; site-gentoo.el ends here
EOF

chmod a+r "${TMPFILE}"

mv "${TMPFILE}" "${SITELISP}"/site-gentoo.el || error "Failed to move site-gentoo.el"

